# Phase 4: Report Generation (REQUIRED)

**Uses Atomic Skill:** `orchestrate-generation`
**Phase Type:** LINEAR (REQUIRED - not optional)

## Purpose

Generate the final research report and persist it to `.claude/research/` directory.

**Note:** Unlike the legacy system where Phase 4 was optional, this phase is REQUIRED. All research workflows must produce a persistent artifact.

## Input

Read synthesized research from Phase 3:
- `.claude/memory/task-{id}-orchestrate-synthesis-memory.md`

Also reference:
- Phase 0 clarification (for topic extraction and format preferences)
- Phase 2 validation (for quality metrics to include in report)
- Depth parameter from `state.metadata["depth"]`

## Configuration

```python
"configuration": {
    "output_directory": ".claude/research/",
    "output_format": "markdown",
}
```

## Domain-Specific Extensions

When generating the final research report:

1. **Format Finalization**
   - Take synthesized content from Phase 3
   - Apply any final formatting polish
   - Ensure consistent markdown structure
   - Add metadata header with generation details

2. **Metadata Addition**
   - Add frontmatter with research metadata
   - Include generation timestamp
   - Note depth level and quality scores
   - Document branch completion status

3. **Quality Metrics Documentation**
   - Include validation scores from Phase 2
   - Note confidence distribution
   - Document source quality breakdown
   - Highlight any limitations or gaps

4. **File Naming and Persistence**
   - Extract topic from task ID or Phase 0 clarification
   - Generate filename in kebab-case
   - Check for existing files to avoid overwriting
   - Write to `.claude/research/` directory

## Output File Format

### Filename Convention

```
.claude/research/research-{topic}-{timestamp}.md
```

**Examples:**
- `research-docker-containers-20260114.md`
- `research-quantum-computing-20260114-143022.md`

**Naming Rules:**
- Extract topic from task ID (e.g., `task-research-docker-containers` → `docker-containers`)
- Use kebab-case (lowercase with hyphens)
- Add date timestamp (YYYYMMDD)
- If file exists, add time (HHMMSS) for uniqueness
- Never overwrite existing files

### File Structure

```markdown
---
research_topic: {topic}
depth: {quick|standard|comprehensive}
generated: {ISO-8601 timestamp}
task_id: {task_id}
quality_score: {overall score from Phase 2}
branch_status: {which branches succeeded: 1A, 1B, 1C}
---

# Research Report: {Topic}

**Generated:** {date}
**Depth Level:** {quick|standard|comprehensive}
**Quality Score:** {X.XX}/1.00
**Research Branches:** {Native: ✓/✗, Perplexity: ✓/✗, Tavily: ✓/✗}

---

{Complete synthesized content from Phase 3}

---

## Research Metadata

### Quality Metrics (from Phase 2 Validation)

| Criterion | Score | Status |
|-----------|-------|--------|
| Factual Accuracy | X.X | PASS/FAIL |
| Citation Accuracy | X.X | PASS/FAIL |
| Source Quality | X.X | PASS/FAIL |
| Completeness | X.X | PASS/FAIL |
| Conflict Resolution | X.X | PASS/FAIL |

**Overall Score:** X.XX / 1.00

### Confidence Distribution

- HIGH confidence findings: X
- MEDIUM confidence findings: Y
- LOW confidence findings: Z

### Source Quality Breakdown

- Tier 1 (Primary sources): X%
- Tier 2 (High-quality secondary): Y%
- Tier 3 (Credible tertiary): Z%
- Tier 4-5 (Use with caution): A%

### Branch Contributions

**Native Web Search (Branch 1A):**
- Status: {COMPLETED/FAILED}
- Queries executed: {count}
- Sources contributed: {count}

**Perplexity AI (Branch 1B):**
- Status: {COMPLETED/FAILED}
- Queries executed: {count}
- Sources contributed: {count}

**Tavily AI (Branch 1C):**
- Status: {COMPLETED/FAILED}
- Queries executed: {count}
- Sources contributed: {count}

### Limitations and Gaps

{From Phase 3 synthesis}

---

*Generated by perform-research skill v1.0*
*Task ID: {task_id}*
```

## Implementation Instructions for orchestrate-generation

1. **Read Phase 3 synthesis memory file**
   - Extract complete synthesized content
   - Preserve all citations and formatting

2. **Extract metadata**
   - Topic from task ID or Phase 0
   - Depth from `state.metadata["depth"]`
   - Quality scores from Phase 2 validation
   - Branch status from Phase 1.5 consolidation

3. **Build frontmatter**
   - YAML format with all metadata fields
   - ISO-8601 timestamp

4. **Construct complete report**
   - Frontmatter
   - Header with metadata summary
   - Complete synthesis content from Phase 3
   - Research metadata appendix
   - Footer with generation info

5. **Generate filename**
   - Extract topic keywords
   - Convert to kebab-case
   - Add timestamp
   - Check for conflicts

6. **Ensure directory exists**
   ```python
   Path(".claude/research").mkdir(parents=True, exist_ok=True)
   ```

7. **Write file**
   - Write to `.claude/research/research-{topic}-{timestamp}.md`
   - Verify write succeeded
   - Return absolute file path

## Gate Exit Criteria

- [ ] Synthesis content retrieved from Phase 3
- [ ] Metadata extracted from all previous phases
- [ ] Frontmatter constructed
- [ ] Complete report assembled
- [ ] Filename generated (no conflicts)
- [ ] `.claude/research/` directory exists
- [ ] File written successfully
- [ ] File path documented in memory file

## Output

### Memory File

Document generation results:
`.claude/memory/task-{id}-orchestrate-generation-memory.md`

```markdown
## Generation Summary

**Output File:** `/absolute/path/to/.claude/research/research-{topic}-{timestamp}.md`
**File Size:** {bytes}
**Generated:** {ISO-8601 timestamp}

## Metadata Applied

- Research Topic: {topic}
- Depth Level: {quick|standard|comprehensive}
- Quality Score: {X.XX}/1.00
- Branch Status: {1A: ✓, 1B: ✗, 1C: ✓}

## Content Statistics

- Total tokens: ~{count}
- Findings included: {count}
- Sources cited: {count}
- Citations: {count}

## File Details

**Location:** `.claude/research/research-{topic}-{timestamp}.md`
**Naming:** {explanation of topic extraction and timestamp}

## Verification

- [ ] File exists at specified path
- [ ] File is readable
- [ ] All sections present
- [ ] Citations intact
- [ ] Metadata complete
```

### Persistent File

**Location:** `.claude/research/research-{topic}-{timestamp}.md`
**Content:** Complete research report as specified in "File Structure" above

## Success Confirmation

After file generation, the orchestrate-generation agent should:
1. Verify file exists
2. Confirm file is readable
3. Return absolute file path in memory file
4. Include file path in Johari Window "Open" section

The skill completion will then present the file path to the user.
